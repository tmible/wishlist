# Wishni bot
Телеграм бот со списками желаний

# Требования к удалённой машине
## Внешние зависимости
- node
- pnpm
- rsync (ддя деплоя)
- certbot
- nginx

## Переменные окружения
- `BOT_TOKEN` токен бота
- `WISHLIST_DB_FILE_PATH` путь к SQLite БД со списками желаний
- `WISHLIST_DB_MIGRATIONS_PATH` путь к папке с SQL скриптами миграций БД со списками желаний
- `LOCAL_DB_PATH` путь к LevelDB БД для горячих данных
- `LOGS_DB_FILE_PATH` путь к SQLite БД для хранения логов
- `LOGS_DB_MIGRATIONS_PATH` путь к папке с SQL скриптами миграций БД для хранения логов
- `HOST` https://используемый_домен
- `PORT` порт для внутреннего сервера
- `HUB_SOCKET_PATH` путь к UNIX сокету IPC хаба для синхронизации списков желаний
- `SUPPORT_ACCOUNT_USERID` идентификтор вспомогательного аккаунта Телеграм
- `SUPPORT_ACCOUNT_2FA_PASSWORD` пароль двухвакторной аутентификации вспомогательного аккаунта Телеграм
- `TELEGRAM_API_ID` [API ID клиента Телегарм](https://core.telegram.org/api/obtaining_api_id)
- `TELEGRAM_API_HASH` [API hash клиента Телегарм](https://core.telegram.org/api/obtaining_api_id)

## Сетевые требования
Бот работает на вебхуках. Поэтому ему нужен reverse proxy с доменом и сертификатом
- nginx, конфигурация которого включает следующий фрагмент:
```nginx
http {
    server {
        server_name {{ используемый_домен }};
        location / {
            proxy_pass http://localhost:{{ порт для внутреннего сервера }};
        }
    }
}
```
- домен. Указывается в переменной окружения и в конфигурации nginx
- TLS сертификат. Устанавливается автоматически с помощью certbot

## TDLib
При первом запуске в новом окружении нужно пройти в консоли аутентификацию во вспомогательный аккаунт. После, TDLib сохраняет сеанс и при перезапусках, если не удалять файлы TDLib или не завершать сеанс на других устройствах, входить повторно не нужно.

# Разработка
Если не задать переменные окружения `HOST` и `PORT`, бот запустится в режиме long polling.

# Про API Телеграм
Создание групп невозможно через Telegram Bot API, поэтому для этого (среди прочего) используется вспомогательный (и поэтому автоматизированный) аккаунт. Бот при запуске создаёт автоматизированный клиент, который создаёт группы. Для этого используются [TDLib](https://core.telegram.org/api#tdlib-build-your-own-telegram) (пакет для js) и переменные окружения `TELEGRAM_API_ID`, `TELEGRAM_API_HASH`.
